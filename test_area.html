<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font: 10px sans-serif;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.browser text {
  text-anchor: end;
}

</style>
<body>


<h1> Change in gut community composition over time.</h1>

<nav>
<h2 id="demo">Phylum</h2>

<!-- Added kingdom as an option since there is one Archaea, but leaving phylum as the default - Alex -->
<select id="phylLevelSelect" onchange="changephylo()">
	<option value="Phylum" selected="selected">Phylum</option>
	<option value="Class">Class</option>
	<option value="Order">Order</option>
	<option value="Family">Family</option>
	<option value="Genus">Genus</option>
	<option value="Species">Species</option>
  <option value="Kingdom">Kingdom</option>
</select>
</nav>


<nav>

<select id="subjectSelect" onchange="changeData()">
  <option value="DonorA" selected="selected">Donor A</option>
  <option value="DonorB">Donor B</option>
</select>
</nav>



<script src="http://d3js.org/d3.v3.js"></script>

<script>

// can switch this variable to be numeric if it would be easier
var phyloLevel = "Phylum";

function changephylo() {
	phyloLevel = document.getElementById("phylLevelSelect").value;
	document.getElementById("demo").innerHTML = phyloLevel;

  // Added redrawing when taxonomic level is switched
  svg.selectAll(".browser").remove();
  svg.selectAll(".axis").remove();
  drawPlot();
}


var dataID = "DonorA";

function changeData() {
  subject = document.getElementById("subjectSelect").value;
  dataID = subject;
  console.log(dataID);
  svg.selectAll(".browser").remove();
  svg.selectAll(".axis").remove();
  drawPlot();
  //need to get it to re-run the plot drawing
}

var margin = {top: 20, right: 20, bottom: 30, left: 50},
    width = 1100 - margin.left - margin.right,
    height = 600 - margin.top - margin.bottom;

var x = d3.scale.linear()
    .range([0, width]);

var y = d3.scale.linear()
    .range([height, 0]);

var color = d3.scale.category20();

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom");

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
    .tickFormat(d3.format(".0%"));

var area = d3.svg.area()
    .x(function(d) { return x(d.Timepoint); })
    .y0(function(d) { return y(d.y0); })
    .y1(function(d) { return y(d.y0 + d.y); });

var stack = d3.layout.stack()
    .values(function(d) { return d.values; });

var tooltip = d3.select("body")
    .append("div")
    .style("position", "absolute")
    .style("z-index", "10")
    .style("visibility", "hidden")
    .style("font-size", "medium")
    .text("a simple tooltip");


var svg = d3.select("body").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");



var drawPlot = function() {

  // Changed file name to match the separate files properly
  d3.tsv(dataID.concat("_").concat(phyloLevel).concat(".txt"), function(error, data) {
    color.domain(d3.keys(data[0]).filter(function(key) { 
    //data[key] = +data[key];
      return key !== "Timepoint"; }));

//  data.forEach(function(d) {
//    d.date = parseDate(d.date);
//  });

    var browsers = stack(color.domain().map(function(name) {
      return {
        name: name,
        values: data.map(function(d) {
          return {Timepoint: +d.Timepoint, y: d[name]*1};
        })
      };
    }));

    x.domain(d3.extent(data, function(d) { return +d.Timepoint; }));
    y.domain([0,1])
  //y.domain(d3.extent(data, function(d) { return +d.Firmicutes; })); //, function(d) { return +d.; }));

    var browser = svg.selectAll(".browser")
        .data(browsers)
        .enter().append("g")
        .attr("class", "browser")
        .on("mouseover", function(d){
          current_data = d3.select(this).datum();
          tooltip.text(current_data.name);
          return tooltip.style("visibility", "visible");
        })
        .on("mousemove", function(){return tooltip.style("top", (d3.event.pageY-10)+"px").style("left",(d3.event.pageX+10)+"px");})
        .on("mouseout", function(){return tooltip.style("visibility", "hidden");});

    browser.append("path")
        .attr("class", "area")
        .attr("d", function(d) {
          return area(d.values); })
        .style("fill", function(d) {
          return color(d.name); });

   browser.append("text")
        .datum(function(d) { return {name: d.name, value: d.values[d.values.length - 1]}; }) //second to last value
        .attr("transform", function(d) { return "translate(" + x(d.value.Timepoint) + "," + y(d.value.y0 + d.value.y / 2) + ")"; })
        .attr("x", -6)
        .attr("dy", ".35em")
        .text(function(d) { return d.name; });

    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", "translate(0," + height + ")")
        .call(xAxis);

    svg.append("g")
        .attr("class", "y axis")
        .call(yAxis);

  });

}

drawPlot();

</script>

</body>